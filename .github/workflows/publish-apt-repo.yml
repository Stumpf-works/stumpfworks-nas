name: Publish to APT Repository

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-and-publish:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debhelper \
            devscripts \
            dpkg-dev \
            build-essential

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build .deb package
        run: |
          # Update version in debian/changelog if needed
          CURRENT_VERSION=$(dpkg-parsechangelog -S Version | cut -d'-' -f1)
          if [ "$CURRENT_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            DEBFULLNAME="Stumpf.Works Team" \
            DEBEMAIL="contact@stumpf.works" \
            dch -v "${{ steps.version.outputs.version }}-1" \
              -D stable \
              "Release version ${{ steps.version.outputs.version }}"
          fi

          # Build package
          dpkg-buildpackage -b -uc -us

          # Move .deb to workspace
          mv ../stumpfworks-nas_*.deb ./

      - name: Upload .deb as release asset
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./stumpfworks-nas_${{ steps.version.outputs.version }}-1_amd64.deb
          asset_name: stumpfworks-nas_${{ steps.version.outputs.version }}-1_amd64.deb
          asset_content_type: application/vnd.debian.binary-package

      - name: Checkout APT repository
        uses: actions/checkout@v4
        with:
          repository: Stumpf-works/stumpfworks-apt-repo
          path: apt-repo
          ref: gh-pages
          token: ${{ secrets.APT_REPO_TOKEN }}

      - name: Add package to APT repository
        run: |
          # Copy .deb package
          mkdir -p apt-repo/pool/main
          cp stumpfworks-nas_*.deb apt-repo/pool/main/

          cd apt-repo

          # Create directory structure
          mkdir -p dists/stable/main/binary-amd64

          # Generate Packages file
          dpkg-scanpackages --arch amd64 pool/ > dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-amd64/Packages

          # Generate Release file
          cd dists/stable
          cat > Release << EOF
          Origin: StumpfWorks
          Label: StumpfWorks NAS
          Suite: stable
          Codename: stable
          Version: 1.0
          Architectures: amd64
          Components: main
          Description: StumpfWorks NAS Official APT Repository
          Date: $(date -Ru)
          EOF

          # Add file checksums
          apt-ftparchive release . >> Release

      - name: Import GPG key
        if: secrets.GPG_PRIVATE_KEY != ''
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys

      - name: Sign repository
        if: secrets.GPG_PRIVATE_KEY != ''
        run: |
          cd apt-repo/dists/stable

          # Remove old signatures
          rm -f Release.gpg InRelease

          # Sign Release file
          gpg --batch --yes --armor --detach-sign --output Release.gpg Release
          gpg --batch --yes --clearsign --output InRelease Release

      - name: Commit and push to APT repository
        run: |
          cd apt-repo

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Add StumpfWorks NAS v${{ steps.version.outputs.version }}" || true
          git push

      - name: Update installation script URL
        run: |
          cd apt-repo

          # Copy installation script
          cp ../apt-repository/install-stumpfworks-nas.sh ./install.sh
          chmod +x ./install.sh

          git add install.sh
          git commit -m "Update installation script" || true
          git push

      - name: Summary
        run: |
          echo "## ðŸ“¦ APT Repository Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** stumpfworks-nas_${{ steps.version.outputs.version }}-1_amd64.deb" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://stumpf-works.github.io/stumpfworks-apt-repo/install.sh | sudo bash" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Add GPG key" >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://stumpf-works.github.io/stumpfworks-apt-repo/stumpfworks.gpg | \\" >> $GITHUB_STEP_SUMMARY
          echo "  sudo gpg --dearmor -o /usr/share/keyrings/stumpfworks-archive-keyring.gpg" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Add repository" >> $GITHUB_STEP_SUMMARY
          echo 'echo "deb [signed-by=/usr/share/keyrings/stumpfworks-archive-keyring.gpg] https://stumpf-works.github.io/stumpfworks-apt-repo stable main" | \' >> $GITHUB_STEP_SUMMARY
          echo "  sudo tee /etc/apt/sources.list.d/stumpfworks-nas.list" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Install" >> $GITHUB_STEP_SUMMARY
          echo "sudo apt update" >> $GITHUB_STEP_SUMMARY
          echo "sudo apt install stumpfworks-nas" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
