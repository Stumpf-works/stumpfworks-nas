name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd frontend && npm install

      - name: Build release binaries
        run: make release

      - name: Create GitHub Release with all assets
        run: |
          # Delete existing release and tag if they exist
          gh release delete ${{ github.ref_name }} --yes || true
          git push --delete origin ${{ github.ref_name }} || true

          # Recreate tag
          git tag -f ${{ github.ref_name }}
          git push -f origin ${{ github.ref_name }}

          # Create release with all assets in one go
          gh release create ${{ github.ref_name }} \
            --title "Stumpf.Works NAS ${{ github.ref_name }}" \
            --notes-file - \
            dist/releases/stumpfworks-nas-linux-amd64 \
            dist/releases/stumpfworks-nas-linux-arm64 \
            dist/releases/stumpfworks-nas-linux-armv7 \
            dist/releases/stumpfworks-nas-darwin-amd64 \
            dist/releases/stumpfworks-nas-darwin-arm64 \
            dist/releases/checksums.txt << 'EOF'
          # Stumpf.Works NAS ${{ github.ref_name }}

          Production-ready NAS management system with web UI.

          ## ðŸ“¦ Downloads

          ### Linux
          - **AMD64 (x86_64)**: `stumpfworks-nas-linux-amd64`
          - **ARM64 (aarch64)**: `stumpfworks-nas-linux-arm64`
          - **ARMv7 (Raspberry Pi)**: `stumpfworks-nas-linux-armv7`

          ### macOS
          - **Intel (AMD64)**: `stumpfworks-nas-darwin-amd64`
          - **Apple Silicon (ARM64)**: `stumpfworks-nas-darwin-arm64`

          ## ðŸš€ Quick Start

          ```bash
          # Download for your platform
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/stumpfworks-nas-linux-amd64

          # Make executable
          chmod +x stumpfworks-nas-linux-amd64

          # Run
          ./stumpfworks-nas-linux-amd64
          ```

          ## ðŸ“‹ Installation

          See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for detailed installation instructions.

          ## âœ… Checksums

          Verify your download with SHA256 checksums in `checksums.txt`:

          ```bash
          sha256sum -c checksums.txt
          ```

          ## ðŸ“ What's New

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

          ---

          **Installation via wget:**
          ```bash
          # Linux AMD64
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/stumpfworks-nas-linux-amd64
          chmod +x stumpfworks-nas-linux-amd64
          sudo mv stumpfworks-nas-linux-amd64 /usr/local/bin/stumpfworks-nas

          # Linux ARM64
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/stumpfworks-nas-linux-arm64
          chmod +x stumpfworks-nas-linux-arm64
          sudo mv stumpfworks-nas-linux-arm64 /usr/local/bin/stumpfworks-nas

          # Raspberry Pi
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/stumpfworks-nas-linux-armv7
          chmod +x stumpfworks-nas-linux-armv7
          sudo mv stumpfworks-nas-linux-armv7 /usr/local/bin/stumpfworks-nas
          ```
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
